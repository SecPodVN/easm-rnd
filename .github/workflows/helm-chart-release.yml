name: Release Helm Chart to GHCR

on:
  push:
    branches:
      - main
    paths:
      - 'src/charts/easm-api/**'
      - '.github/workflows/helm-chart-release.yml'
  release:
    types: [published]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  CHART_NAME: easm-api
  CHART_PATH: ./src/charts/easm-api

permissions:
  contents: read
  packages: write

jobs:
  release-chart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.19.0'

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin

      - name: Extract chart version
        id: chart_version
        run: |
          CHART_VERSION=$(grep '^version:' ${{ env.CHART_PATH }}/Chart.yaml | awk '{print $2}')
          echo "version=${CHART_VERSION}" >> $GITHUB_OUTPUT
          echo "Chart version: ${CHART_VERSION}"

      - name: Package Helm chart
        run: |
          helm package ${{ env.CHART_PATH }} --destination .

      - name: Push Helm chart to GHCR
        run: |
          CHART_VERSION="${{ steps.chart_version.outputs.version }}"
          CHART_PACKAGE="${{ env.CHART_NAME }}-${CHART_VERSION}.tgz"

          helm push ${CHART_PACKAGE} oci://${{ env.REGISTRY }}/${{ github.repository_owner }}

      - name: Upload chart package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-${{ steps.chart_version.outputs.version }}
          path: ${{ env.CHART_NAME }}-${{ steps.chart_version.outputs.version }}.tgz
          retention-days: 30

      - name: Chart release summary
        run: |
          echo "### Helm Chart Released ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart Name:** ${{ env.CHART_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.chart_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.CHART_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "helm pull oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.CHART_NAME }} --version ${{ steps.chart_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "helm install easm-api oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.CHART_NAME }} --version ${{ steps.chart_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
