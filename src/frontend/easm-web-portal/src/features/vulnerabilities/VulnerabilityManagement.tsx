import React, { useState } from 'react';
import {
  Box,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  IconButton,
  Button,
  Typography,
  LinearProgress,
  Tabs,
  Tab,
  Menu,
  MenuItem,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Select,
  FormControl,
  InputLabel,
  Checkbox,
  FormControlLabel,
  Divider,
  Card,
  CardContent,
  Stepper,
  Step,
  StepLabel,
  Tooltip,
  Badge,
  ToggleButtonGroup,
  ToggleButton,
  Alert,
  AlertTitle,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
} from '@mui/material';
import {
  BugReport as BugIcon,
  Security as SecurityIcon,
  Warning as WarningIcon,
  CheckCircle as CheckIcon,
  MoreVert as MoreVertIcon,
  Assignment as AssignmentIcon,
  Search as SearchIcon,
  Build as FixIcon,
  Block as FalsePositiveIcon,
  Person as AssignIcon,
  FilterList as FilterIcon,
  Refresh as RefreshIcon,
  Download as DownloadIcon,
  TrendingUp as TrendingUpIcon,
  Timeline as TimelineIcon,
  VpnKey as LeakIcon,
  Domain as DomainIssueIcon,
  Security as CertIssueIcon,
  BarChart as ProgressIcon,
  Info as InfoIcon,
  Upgrade as UpgradeIcon,
  PlayArrow as ApplyIcon,
} from '@mui/icons-material';
import { PageHeader, SearchBar } from '../../shared/components';

interface Vulnerability {
  id: string;
  cve: string;
  title: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  cvss: number;
  affectedAssets: number;
  status: 'open' | 'in-progress' | 'resolved' | 'false-positive';
  exploitAvailable: boolean;
  kev: boolean;
  issueType: 'vulnerability' | 'leaked-credential' | 'certificate' | 'domain';
  assignedTo?: string;
  dueDate?: string;
  progress?: number;
  remediationSteps?: string[];
  cvsm?: string; // CVEM scanner integration
}

type ViewMode = 'list' | 'kanban';

const VulnerabilityManagement: React.FC = () => {
  const [searchQuery, setSearchQuery] = useState('');
  const [currentTab, setCurrentTab] = useState(0);
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);
  const [viewMode, setViewMode] = useState<ViewMode>('list');

  // Dialog states
  const [fixDialogOpen, setFixDialogOpen] = useState(false);
  const [assignDialogOpen, setAssignDialogOpen] = useState(false);
  const [detailsDialogOpen, setDetailsDialogOpen] = useState(false);
  const [progressDialogOpen, setProgressDialogOpen] = useState(false);

  // Filters
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [issueTypeFilter, setIssueTypeFilter] = useState<string>('all');
  const [advancedFiltersOpen, setAdvancedFiltersOpen] = useState(false);
  const [selectedIssues, setSelectedIssues] = useState<string[]>([]);

  // Fix dialog state
  const [fixActiveStep, setFixActiveStep] = useState(0);
  const [fixNotes, setFixNotes] = useState('');

  // Assign dialog state
  const [assignee, setAssignee] = useState('');
  const [dueDate, setDueDate] = useState('');
  const [priority, setPriority] = useState('medium');

  // Advanced filters state
  const [cvssMin, setCvssMin] = useState(0);
  const [cvssMax, setCvssMax] = useState(10);
  const [assigneeFilter, setAssigneeFilter] = useState('all');
  const [kevOnly, setKevOnly] = useState(false);
  const [exploitOnly, setExploitOnly] = useState(false);

  const mockVulnerabilities: Vulnerability[] = [
    {
      id: '1',
      cve: 'CVE-2023-21709',
      title: 'Microsoft Exchange Server Elevation of Privilege',
      severity: 'critical',
      cvss: 9.8,
      affectedAssets: 16,
      status: 'open',
      exploitAvailable: true,
      kev: true,
      issueType: 'vulnerability',
      assignedTo: 'John Doe',
      dueDate: '2025-11-25',
      progress: 0,
      remediationSteps: [
        'Identify affected Exchange servers',
        'Test patch in staging environment',
        'Deploy patch to production',
        'Verify remediation',
      ],
      cvsm: 'Nessus',
    },
    {
      id: '2',
      cve: 'CVE-2023-28310',
      title: 'Microsoft Exchange Server Authenticated Remote Code Execution',
      severity: 'high',
      cvss: 8.8,
      affectedAssets: 12,
      status: 'in-progress',
      exploitAvailable: true,
      kev: false,
      issueType: 'vulnerability',
      assignedTo: 'Jane Smith',
      dueDate: '2025-11-30',
      progress: 50,
      cvsm: 'Qualys',
    },
    {
      id: '3',
      cve: 'CVE-2023-21529',
      title: 'Microsoft Exchange Server Authenticated Remote Code Execution',
      severity: 'high',
      cvss: 8.2,
      affectedAssets: 8,
      status: 'open',
      exploitAvailable: false,
      kev: false,
      issueType: 'vulnerability',
      progress: 0,
    },
    {
      id: '4',
      cve: 'LEAK-2023-001',
      title: 'Exposed API Keys in Public Repository',
      severity: 'critical',
      cvss: 9.5,
      affectedAssets: 3,
      status: 'in-progress',
      exploitAvailable: true,
      kev: false,
      issueType: 'leaked-credential',
      assignedTo: 'Security Team',
      dueDate: '2025-11-21',
      progress: 75,
    },
    {
      id: '5',
      cve: 'CERT-2023-045',
      title: 'Expired SSL Certificate on *.example.com',
      severity: 'high',
      cvss: 7.5,
      affectedAssets: 24,
      status: 'open',
      exploitAvailable: false,
      kev: false,
      issueType: 'certificate',
      progress: 0,
    },
    {
      id: '6',
      cve: 'DOM-2023-012',
      title: 'Domain Registration Expiring Soon',
      severity: 'medium',
      cvss: 5.0,
      affectedAssets: 2,
      status: 'resolved',
      exploitAvailable: false,
      kev: false,
      issueType: 'domain',
      assignedTo: 'IT Operations',
      progress: 100,
    },
  ];

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'error';
      case 'high': return 'warning';
      case 'medium': return 'info';
      case 'low': return 'success';
      default: return 'default';
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'open': return 'error';
      case 'in-progress': return 'warning';
      case 'resolved': return 'success';
      default: return 'default';
    }
  };

  const getIssueTypeIcon = (type: string) => {
    switch (type) {
      case 'vulnerability': return <BugIcon fontSize="small" />;
      case 'leaked-credential': return <LeakIcon fontSize="small" />;
      case 'certificate': return <CertIssueIcon fontSize="small" />;
      case 'domain': return <DomainIssueIcon fontSize="small" />;
      default: return <InfoIcon fontSize="small" />;
    }
  };

  // Action Handlers
  const handleOpenFix = (vuln: Vulnerability) => {
    setSelectedVuln(vuln);
    setFixActiveStep(0);
    setFixNotes('');
    setFixDialogOpen(true);
    setAnchorEl(null);
  };

  const handleOpenAssign = (vuln: Vulnerability) => {
    setSelectedVuln(vuln);
    setAssignee(vuln.assignedTo || '');
    setDueDate(vuln.dueDate || '');
    setPriority('medium');
    setAssignDialogOpen(true);
    setAnchorEl(null);
  };

  const handleOpenDetails = (vuln: Vulnerability) => {
    setSelectedVuln(vuln);
    setDetailsDialogOpen(true);
    setAnchorEl(null);
  };

  const handleOpenProgress = (vuln: Vulnerability) => {
    setSelectedVuln(vuln);
    setProgressDialogOpen(true);
    setAnchorEl(null);
  };

  const handleMarkFalsePositive = (vuln: Vulnerability) => {
    console.log('Marking as false positive:', vuln.id);
    setAnchorEl(null);
  };

  const handleMarkResolved = (vuln: Vulnerability) => {
    console.log('Marking as resolved:', vuln.id);
    setAnchorEl(null);
  };

  const handleDelete = (vuln: Vulnerability) => {
    console.log('Deleting:', vuln.id);
    setAnchorEl(null);
  };

  const handleToggleIssueSelection = (id: string) => {
    setSelectedIssues(prev =>
      prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
    );
  };

  const handleSelectAll = () => {
    if (selectedIssues.length === mockVulnerabilities.length) {
      setSelectedIssues([]);
    } else {
      setSelectedIssues(mockVulnerabilities.map(v => v.id));
    }
  };

  const handleBulkAssign = () => {
    console.log('Bulk assigning:', selectedIssues);
  };

  const handleBulkStatusUpdate = (status: string) => {
    console.log('Bulk status update:', selectedIssues, status);
  };

  const filteredVulnerabilities = mockVulnerabilities.filter(vuln => {
    if (statusFilter !== 'all' && vuln.status !== statusFilter) return false;
    if (issueTypeFilter !== 'all' && vuln.issueType !== issueTypeFilter) return false;
    if (assigneeFilter !== 'all' && vuln.assignedTo !== assigneeFilter) return false;
    if (kevOnly && !vuln.kev) return false;
    if (exploitOnly && !vuln.exploitAvailable) return false;
    if (vuln.cvss < cvssMin || vuln.cvss > cvssMax) return false;
    if (searchQuery && !vuln.title.toLowerCase().includes(searchQuery.toLowerCase()) &&
        !vuln.cve.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  const vulnCounts = {
    all: mockVulnerabilities.length,
    critical: mockVulnerabilities.filter(v => v.severity === 'critical').length,
    high: mockVulnerabilities.filter(v => v.severity === 'high').length,
    medium: mockVulnerabilities.filter(v => v.severity === 'medium').length,
    low: mockVulnerabilities.filter(v => v.severity === 'low').length,
  };

  const renderKanbanView = () => {
    const statuses = ['open', 'in-progress', 'resolved', 'false-positive'];
    const statusLabels = {
      'open': 'Open',
      'in-progress': 'In Progress',
      'resolved': 'Resolved',
      'false-positive': 'False Positive',
    };

    return (
      <Box sx={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 2 }}>
        {statuses.map(status => {
          const issues = filteredVulnerabilities.filter(v => v.status === status);
          return (
            <Paper key={status} sx={{ p: 2 }}>
              <Box sx={{ mb: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <Typography variant="h6" sx={{ fontWeight: 600 }}>
                  {statusLabels[status as keyof typeof statusLabels]}
                </Typography>
                <Chip label={issues.length} size="small" />
              </Box>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                {issues.map(vuln => (
                  <Card key={vuln.id} sx={{ cursor: 'pointer' }} onClick={() => handleOpenDetails(vuln)}>
                    <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
                        {getIssueTypeIcon(vuln.issueType)}
                        <Typography variant="body2" sx={{ fontWeight: 600, fontFamily: 'monospace' }}>
                          {vuln.cve}
                        </Typography>
                      </Box>
                      <Typography variant="body2" sx={{ mb: 1 }} noWrap>
                        {vuln.title}
                      </Typography>
                      <Box sx={{ display: 'flex', gap: 0.5, flexWrap: 'wrap' }}>
                        <Chip label={vuln.severity} size="small" color={getSeverityColor(vuln.severity) as any} />
                        <Chip label={`CVSS ${vuln.cvss}`} size="small" variant="outlined" />
                        {vuln.assignedTo && (
                          <Chip label={vuln.assignedTo} size="small" icon={<AssignIcon />} />
                        )}
                      </Box>
                      {vuln.progress !== undefined && (
                        <Box sx={{ mt: 1 }}>
                          <LinearProgress variant="determinate" value={vuln.progress} sx={{ height: 4, borderRadius: 2 }} />
                        </Box>
                      )}
                    </CardContent>
                  </Card>
                ))}
              </Box>
            </Paper>
          );
        })}
      </Box>
    );
  };

  return (
    <Box>
      <PageHeader
        title="Vulnerability Management"
        subtitle="Track and remediate vulnerabilities across your attack surface"
        breadcrumbs={[
          { label: 'Vulnerabilities' },
        ]}
        actions={
          <Button startIcon={<AssignmentIcon />} variant="contained">
            Create Remediation Plan
          </Button>
        }
      />

      {/* Summary Cards */}
      <Box sx={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 2, mb: 3 }}>
        <Paper sx={{ p: 2 }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
            <Typography variant="body2" color="text.secondary">Critical</Typography>
            <BugIcon color="error" />
          </Box>
          <Typography variant="h4" sx={{ fontWeight: 600 }}>{vulnCounts.critical}</Typography>
          <LinearProgress
            variant="determinate"
            value={75}
            color="error"
            sx={{ mt: 1, height: 6, borderRadius: 3 }}
          />
        </Paper>

        <Paper sx={{ p: 2 }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
            <Typography variant="body2" color="text.secondary">High</Typography>
            <WarningIcon color="warning" />
          </Box>
          <Typography variant="h4" sx={{ fontWeight: 600 }}>{vulnCounts.high}</Typography>
          <LinearProgress
            variant="determinate"
            value={45}
            color="warning"
            sx={{ mt: 1, height: 6, borderRadius: 3 }}
          />
        </Paper>

        <Paper sx={{ p: 2 }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
            <Typography variant="body2" color="text.secondary">Medium</Typography>
            <SecurityIcon color="info" />
          </Box>
          <Typography variant="h4" sx={{ fontWeight: 600 }}>{vulnCounts.medium}</Typography>
          <LinearProgress
            variant="determinate"
            value={30}
            color="info"
            sx={{ mt: 1, height: 6, borderRadius: 3 }}
          />
        </Paper>

        <Paper sx={{ p: 2 }}>
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
            <Typography variant="body2" color="text.secondary">Low</Typography>
            <CheckIcon color="success" />
          </Box>
          <Typography variant="h4" sx={{ fontWeight: 600 }}>{vulnCounts.low}</Typography>
          <LinearProgress
            variant="determinate"
            value={10}
            color="success"
            sx={{ mt: 1, height: 6, borderRadius: 3 }}
          />
        </Paper>
      </Box>

      <Paper sx={{ mb: 2 }}>
        <Tabs
          value={currentTab}
          onChange={(_, newValue) => setCurrentTab(newValue)}
          sx={{ borderBottom: 1, borderColor: 'divider', px: 2 }}
        >
          <Tab label={`All (${vulnCounts.all})`} />
          <Tab label={`Critical (${vulnCounts.critical})`} />
          <Tab label={`High (${vulnCounts.high})`} />
          <Tab label="KEV Only" />
          <Tab label="Exploitable" />
        </Tabs>
      </Paper>

      <Paper sx={{ p: 3 }}>
        {/* Toolbar */}
        <Box sx={{ mb: 3, display: 'flex', gap: 2, alignItems: 'center', flexWrap: 'wrap' }}>
          <Box sx={{ flex: 1 }}>
            <SearchBar
              placeholder="Search by CVE, title, or affected assets..."
              value={searchQuery}
              onChange={setSearchQuery}
              fullWidth
            />
          </Box>

          <ToggleButtonGroup
            value={viewMode}
            exclusive
            onChange={(_, value) => value && setViewMode(value)}
            size="small"
          >
            <ToggleButton value="list">
              <Tooltip title="List View"><Box>List</Box></Tooltip>
            </ToggleButton>
            <ToggleButton value="kanban">
              <Tooltip title="Kanban View"><Box>Kanban</Box></Tooltip>
            </ToggleButton>
          </ToggleButtonGroup>

          <Button
            startIcon={<FilterIcon />}
            variant={advancedFiltersOpen ? 'contained' : 'outlined'}
            onClick={() => setAdvancedFiltersOpen(!advancedFiltersOpen)}
            size="small"
          >
            Filters
          </Button>

          <Button startIcon={<RefreshIcon />} variant="outlined" size="small">
            Refresh
          </Button>

          <Button startIcon={<DownloadIcon />} variant="outlined" size="small">
            Export
          </Button>
        </Box>

        {/* Advanced Filters Panel */}
        {advancedFiltersOpen && (
          <Paper sx={{ p: 2, mb: 3, bgcolor: 'grey.50' }}>
            <Typography variant="subtitle2" sx={{ mb: 2, fontWeight: 600 }}>Advanced Filters</Typography>
            <Box sx={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 2 }}>
              <FormControl size="small" fullWidth>
                <InputLabel>Status</InputLabel>
                <Select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} label="Status">
                  <MenuItem value="all">All Statuses</MenuItem>
                  <MenuItem value="open">Open</MenuItem>
                  <MenuItem value="in-progress">In Progress</MenuItem>
                  <MenuItem value="resolved">Resolved</MenuItem>
                  <MenuItem value="false-positive">False Positive</MenuItem>
                </Select>
              </FormControl>

              <FormControl size="small" fullWidth>
                <InputLabel>Issue Type</InputLabel>
                <Select value={issueTypeFilter} onChange={(e) => setIssueTypeFilter(e.target.value)} label="Issue Type">
                  <MenuItem value="all">All Types</MenuItem>
                  <MenuItem value="vulnerability">Vulnerability</MenuItem>
                  <MenuItem value="leaked-credential">Leaked Credential</MenuItem>
                  <MenuItem value="certificate">Certificate</MenuItem>
                  <MenuItem value="domain">Domain</MenuItem>
                </Select>
              </FormControl>

              <FormControl size="small" fullWidth>
                <InputLabel>Assignee</InputLabel>
                <Select value={assigneeFilter} onChange={(e) => setAssigneeFilter(e.target.value)} label="Assignee">
                  <MenuItem value="all">All Assignees</MenuItem>
                  <MenuItem value="John Doe">John Doe</MenuItem>
                  <MenuItem value="Jane Smith">Jane Smith</MenuItem>
                  <MenuItem value="Security Team">Security Team</MenuItem>
                  <MenuItem value="IT Operations">IT Operations</MenuItem>
                </Select>
              </FormControl>

              <Box>
                <Typography variant="caption" color="text.secondary">CVSS Range: {cvssMin} - {cvssMax}</Typography>
                <Box sx={{ display: 'flex', gap: 1, mt: 0.5 }}>
                  <TextField
                    type="number"
                    size="small"
                    label="Min"
                    value={cvssMin}
                    onChange={(e) => setCvssMin(Number(e.target.value))}
                    inputProps={{ min: 0, max: 10, step: 0.1 }}
                    sx={{ width: '80px' }}
                  />
                  <TextField
                    type="number"
                    size="small"
                    label="Max"
                    value={cvssMax}
                    onChange={(e) => setCvssMax(Number(e.target.value))}
                    inputProps={{ min: 0, max: 10, step: 0.1 }}
                    sx={{ width: '80px' }}
                  />
                </Box>
              </Box>

              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                <FormControlLabel
                  control={<Checkbox checked={kevOnly} onChange={(e) => setKevOnly(e.target.checked)} size="small" />}
                  label="KEV Only"
                />
                <FormControlLabel
                  control={<Checkbox checked={exploitOnly} onChange={(e) => setExploitOnly(e.target.checked)} size="small" />}
                  label="Exploit Available"
                />
              </Box>
            </Box>
          </Paper>
        )}

        {/* Bulk Actions */}
        {selectedIssues.length > 0 && (
          <Alert severity="info" sx={{ mb: 2 }}>
            <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
              <AlertTitle sx={{ mb: 0 }}>{selectedIssues.length} issues selected</AlertTitle>
              <Box sx={{ display: 'flex', gap: 1 }}>
                <Button size="small" variant="outlined" onClick={handleBulkAssign}>Bulk Assign</Button>
                <Button size="small" variant="outlined" onClick={() => handleBulkStatusUpdate('in-progress')}>Mark In Progress</Button>
                <Button size="small" variant="outlined" onClick={() => handleBulkStatusUpdate('resolved')}>Mark Resolved</Button>
                <Button size="small" variant="outlined" color="error" onClick={() => setSelectedIssues([])}>Clear</Button>
              </Box>
            </Box>
          </Alert>
        )}

        {/* View Content */}
        {viewMode === 'kanban' ? renderKanbanView() : (
          <TableContainer>
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell padding="checkbox">
                    <Checkbox
                      checked={selectedIssues.length === mockVulnerabilities.length}
                      indeterminate={selectedIssues.length > 0 && selectedIssues.length < mockVulnerabilities.length}
                      onChange={handleSelectAll}
                    />
                  </TableCell>
                  <TableCell>Type</TableCell>
                  <TableCell>CVE/ID</TableCell>
                  <TableCell>Title</TableCell>
                  <TableCell>Severity</TableCell>
                  <TableCell>CVSS</TableCell>
                  <TableCell>Affected Assets</TableCell>
                  <TableCell>Status</TableCell>
                  <TableCell>Assignee</TableCell>
                  <TableCell>Progress</TableCell>
                  <TableCell>Flags</TableCell>
                  <TableCell align="right">Actions</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {filteredVulnerabilities.map((vuln) => (
                  <TableRow key={vuln.id} hover selected={selectedIssues.includes(vuln.id)}>
                    <TableCell padding="checkbox">
                      <Checkbox
                        checked={selectedIssues.includes(vuln.id)}
                        onChange={() => handleToggleIssueSelection(vuln.id)}
                      />
                    </TableCell>
                    <TableCell>
                      <Tooltip title={vuln.issueType.replace('-', ' ')}>
                        {getIssueTypeIcon(vuln.issueType)}
                      </Tooltip>
                    </TableCell>
                    <TableCell sx={{ fontFamily: 'monospace', fontWeight: 600 }}>
                      {vuln.cve}
                    </TableCell>
                    <TableCell sx={{ maxWidth: 300 }}>
                      <Typography variant="body2" noWrap>
                        {vuln.title}
                      </Typography>
                    </TableCell>
                    <TableCell>
                      <Chip
                        label={vuln.severity.toUpperCase()}
                        size="small"
                        color={getSeverityColor(vuln.severity) as any}
                      />
                    </TableCell>
                    <TableCell>
                      <Chip
                        label={vuln.cvss.toFixed(1)}
                        size="small"
                        sx={{
                          bgcolor: vuln.cvss >= 9 ? '#d32f2f' : vuln.cvss >= 7 ? '#ed6c02' : '#0288d1',
                          color: 'white',
                          fontWeight: 600,
                        }}
                      />
                    </TableCell>
                    <TableCell>
                      <Chip label={vuln.affectedAssets} size="small" color="primary" variant="outlined" />
                    </TableCell>
                    <TableCell>
                      <Chip
                        label={vuln.status.replace('-', ' ')}
                        size="small"
                        color={getStatusColor(vuln.status) as any}
                      />
                    </TableCell>
                    <TableCell>
                      {vuln.assignedTo ? (
                        <Chip label={vuln.assignedTo} size="small" icon={<AssignIcon />} />
                      ) : (
                        <Typography variant="caption" color="text.secondary">Unassigned</Typography>
                      )}
                    </TableCell>
                    <TableCell sx={{ minWidth: 120 }}>
                      {vuln.progress !== undefined && (
                        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                          <LinearProgress
                            variant="determinate"
                            value={vuln.progress}
                            sx={{ flex: 1, height: 6, borderRadius: 3 }}
                          />
                          <Typography variant="caption">{vuln.progress}%</Typography>
                        </Box>
                      )}
                    </TableCell>
                    <TableCell>
                      <Box sx={{ display: 'flex', gap: 0.5 }}>
                        {vuln.kev && (
                          <Chip label="KEV" size="small" color="error" sx={{ fontSize: '0.65rem' }} />
                        )}
                        {vuln.exploitAvailable && (
                          <Chip label="Exploit" size="small" color="warning" sx={{ fontSize: '0.65rem' }} />
                        )}
                      </Box>
                    </TableCell>
                    <TableCell align="right">
                      <IconButton
                        size="small"
                        onClick={(e) => {
                          setSelectedVuln(vuln);
                          setAnchorEl(e.currentTarget);
                        }}
                      >
                        <MoreVertIcon fontSize="small" />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        )}
      </Paper>

      {/* Context Menu */}
      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={() => setAnchorEl(null)}
      >
        <MenuItem onClick={() => selectedVuln && handleOpenDetails(selectedVuln)}>
          <ListItemIcon><InfoIcon fontSize="small" /></ListItemIcon>
          <ListItemText>View Details</ListItemText>
        </MenuItem>
        <MenuItem onClick={() => selectedVuln && handleOpenFix(selectedVuln)}>
          <ListItemIcon><FixIcon fontSize="small" /></ListItemIcon>
          <ListItemText>Fix Issue</ListItemText>
        </MenuItem>
        <MenuItem onClick={() => selectedVuln && handleOpenAssign(selectedVuln)}>
          <ListItemIcon><AssignIcon fontSize="small" /></ListItemIcon>
          <ListItemText>Assign</ListItemText>
        </MenuItem>
        <MenuItem onClick={() => selectedVuln && handleOpenProgress(selectedVuln)}>
          <ListItemIcon><ProgressIcon fontSize="small" /></ListItemIcon>
          <ListItemText>Track Progress</ListItemText>
        </MenuItem>
        <Divider />
        {selectedVuln?.issueType === 'vulnerability' && selectedVuln.cvsm && (
          <>
            <MenuItem onClick={() => selectedVuln && console.log('Upgrade patch:', selectedVuln.id)}>
              <ListItemIcon><UpgradeIcon fontSize="small" /></ListItemIcon>
              <ListItemText>Upgrade/Apply Patch (CVEM)</ListItemText>
            </MenuItem>
            <Divider />
          </>
        )}
        <MenuItem onClick={() => selectedVuln && handleMarkFalsePositive(selectedVuln)}>
          <ListItemIcon><FalsePositiveIcon fontSize="small" /></ListItemIcon>
          <ListItemText>Mark as False Positive</ListItemText>
        </MenuItem>
        <MenuItem onClick={() => selectedVuln && handleMarkResolved(selectedVuln)}>
          <ListItemIcon><CheckIcon fontSize="small" /></ListItemIcon>
          <ListItemText>Mark as Resolved</ListItemText>
        </MenuItem>
      </Menu>

      {/* Fix Dialog */}
      <Dialog open={fixDialogOpen} onClose={() => setFixDialogOpen(false)} maxWidth="md" fullWidth>
        <DialogTitle>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <FixIcon />
            Fix Issue: {selectedVuln?.cve}
          </Box>
        </DialogTitle>
        <DialogContent>
          {selectedVuln && (
            <>
              <Alert severity="info" sx={{ mb: 3 }}>
                <AlertTitle>{selectedVuln.title}</AlertTitle>
                <Typography variant="body2">
                  Severity: <strong>{selectedVuln.severity.toUpperCase()}</strong> | CVSS: <strong>{selectedVuln.cvss}</strong> |
                  Affected Assets: <strong>{selectedVuln.affectedAssets}</strong>
                </Typography>
              </Alert>

              <Typography variant="subtitle2" sx={{ mb: 2, fontWeight: 600 }}>Remediation Steps</Typography>
              <Stepper activeStep={fixActiveStep} orientation="vertical" sx={{ mb: 3 }}>
                {(selectedVuln.remediationSteps || ['Assess impact', 'Plan remediation', 'Execute fix', 'Verify resolution']).map((step, index) => (
                  <Step key={index}>
                    <StepLabel>
                      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', width: '100%' }}>
                        <Typography>{step}</Typography>
                        {index <= fixActiveStep && (
                          <Button
                            size="small"
                            onClick={() => setFixActiveStep(Math.min(index + 1, (selectedVuln.remediationSteps?.length || 4) - 1))}
                          >
                            {index === fixActiveStep ? 'Complete' : 'Completed'}
                          </Button>
                        )}
                      </Box>
                    </StepLabel>
                  </Step>
                ))}
              </Stepper>

              <TextField
                label="Remediation Notes"
                multiline
                rows={4}
                fullWidth
                value={fixNotes}
                onChange={(e) => setFixNotes(e.target.value)}
                placeholder="Document actions taken, challenges encountered, or additional context..."
              />

              {selectedVuln.cvsm && (
                <Alert severity="info" sx={{ mt: 2 }}>
                  Detected by scanner: <strong>{selectedVuln.cvsm}</strong>
                </Alert>
              )}
            </>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setFixDialogOpen(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={() => {
              console.log('Fix applied with notes:', fixNotes);
              setFixDialogOpen(false);
            }}
          >
            Mark as Resolved
          </Button>
        </DialogActions>
      </Dialog>

      {/* Assign Dialog */}
      <Dialog open={assignDialogOpen} onClose={() => setAssignDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <AssignIcon />
            Assign Issue
          </Box>
        </DialogTitle>
        <DialogContent>
          <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 2 }}>
            <FormControl fullWidth>
              <InputLabel>Assignee</InputLabel>
              <Select value={assignee} onChange={(e) => setAssignee(e.target.value)} label="Assignee">
                <MenuItem value="">Unassigned</MenuItem>
                <MenuItem value="John Doe">John Doe</MenuItem>
                <MenuItem value="Jane Smith">Jane Smith</MenuItem>
                <MenuItem value="Security Team">Security Team</MenuItem>
                <MenuItem value="IT Operations">IT Operations</MenuItem>
              </Select>
            </FormControl>

            <TextField
              label="Due Date"
              type="date"
              fullWidth
              value={dueDate}
              onChange={(e) => setDueDate(e.target.value)}
              InputLabelProps={{ shrink: true }}
            />

            <FormControl fullWidth>
              <InputLabel>Priority</InputLabel>
              <Select value={priority} onChange={(e) => setPriority(e.target.value)} label="Priority">
                <MenuItem value="low">Low</MenuItem>
                <MenuItem value="medium">Medium</MenuItem>
                <MenuItem value="high">High</MenuItem>
                <MenuItem value="critical">Critical</MenuItem>
              </Select>
            </FormControl>

            {selectedVuln && (
              <Alert severity="warning">
                This issue affects <strong>{selectedVuln.affectedAssets}</strong> assets
              </Alert>
            )}
          </Box>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setAssignDialogOpen(false)}>Cancel</Button>
          <Button
            variant="contained"
            onClick={() => {
              console.log('Assigned to:', assignee, 'Due:', dueDate, 'Priority:', priority);
              setAssignDialogOpen(false);
            }}
          >
            Assign
          </Button>
        </DialogActions>
      </Dialog>

      {/* Details Dialog */}
      <Dialog open={detailsDialogOpen} onClose={() => setDetailsDialogOpen(false)} maxWidth="md" fullWidth>
        <DialogTitle>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <InfoIcon />
            Issue Details
          </Box>
        </DialogTitle>
        <DialogContent>
          {selectedVuln && (
            <>
              <Box sx={{ mb: 3 }}>
                <Typography variant="h6" gutterBottom>{selectedVuln.title}</Typography>
                <Box sx={{ display: 'flex', gap: 1, mb: 2 }}>
                  <Chip label={selectedVuln.cve} size="small" sx={{ fontFamily: 'monospace' }} />
                  <Chip label={selectedVuln.severity.toUpperCase()} size="small" color={getSeverityColor(selectedVuln.severity) as any} />
                  <Chip label={`CVSS ${selectedVuln.cvss}`} size="small" />
                  <Chip label={selectedVuln.issueType.replace('-', ' ')} size="small" variant="outlined" />
                </Box>
              </Box>

              <Divider sx={{ my: 2 }} />

              <Box sx={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 2, mb: 3 }}>
                <Box>
                  <Typography variant="caption" color="text.secondary">Status</Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>
                    {selectedVuln.status.replace('-', ' ').toUpperCase()}
                  </Typography>
                </Box>
                <Box>
                  <Typography variant="caption" color="text.secondary">Affected Assets</Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>{selectedVuln.affectedAssets}</Typography>
                </Box>
                <Box>
                  <Typography variant="caption" color="text.secondary">Assignee</Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>{selectedVuln.assignedTo || 'Unassigned'}</Typography>
                </Box>
                <Box>
                  <Typography variant="caption" color="text.secondary">Due Date</Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>{selectedVuln.dueDate || 'Not set'}</Typography>
                </Box>
                <Box>
                  <Typography variant="caption" color="text.secondary">KEV Status</Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>{selectedVuln.kev ? 'Yes' : 'No'}</Typography>
                </Box>
                <Box>
                  <Typography variant="caption" color="text.secondary">Exploit Available</Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>{selectedVuln.exploitAvailable ? 'Yes' : 'No'}</Typography>
                </Box>
              </Box>

              {selectedVuln.cvsm && (
                <>
                  <Divider sx={{ my: 2 }} />
                  <Typography variant="subtitle2" sx={{ mb: 1, fontWeight: 600 }}>Scanner Information</Typography>
                  <Alert severity="info">Detected by: <strong>{selectedVuln.cvsm}</strong></Alert>
                </>
              )}

              {selectedVuln.remediationSteps && selectedVuln.remediationSteps.length > 0 && (
                <>
                  <Divider sx={{ my: 2 }} />
                  <Typography variant="subtitle2" sx={{ mb: 1, fontWeight: 600 }}>Remediation Steps</Typography>
                  <List dense>
                    {selectedVuln.remediationSteps.map((step, index) => (
                      <ListItem key={index}>
                        <ListItemIcon>
                          <Typography variant="body2" sx={{ fontWeight: 600 }}>{index + 1}.</Typography>
                        </ListItemIcon>
                        <ListItemText primary={step} />
                      </ListItem>
                    ))}
                  </List>
                </>
              )}
            </>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setDetailsDialogOpen(false)}>Close</Button>
          <Button variant="outlined" onClick={() => selectedVuln && handleOpenFix(selectedVuln)}>
            Fix Issue
          </Button>
        </DialogActions>
      </Dialog>

      {/* Progress Dialog */}
      <Dialog open={progressDialogOpen} onClose={() => setProgressDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <ProgressIcon />
            Track Progress
          </Box>
        </DialogTitle>
        <DialogContent>
          {selectedVuln && (
            <>
              <Typography variant="subtitle2" sx={{ mb: 2 }}>{selectedVuln.cve} - {selectedVuln.title}</Typography>

              <Box sx={{ mb: 3 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                  <Typography variant="body2" color="text.secondary">Overall Progress</Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>{selectedVuln.progress || 0}%</Typography>
                </Box>
                <LinearProgress
                  variant="determinate"
                  value={selectedVuln.progress || 0}
                  sx={{ height: 8, borderRadius: 4 }}
                />
              </Box>

              <Typography variant="subtitle2" sx={{ mb: 2, fontWeight: 600 }}>Timeline</Typography>
              <List>
                <ListItem>
                  <ListItemIcon><TimelineIcon fontSize="small" /></ListItemIcon>
                  <ListItemText
                    primary="Issue Identified"
                    secondary="Status changed to Open"
                  />
                  <Typography variant="caption" color="text.secondary">2 days ago</Typography>
                </ListItem>
                {selectedVuln.assignedTo && (
                  <ListItem>
                    <ListItemIcon><AssignIcon fontSize="small" /></ListItemIcon>
                    <ListItemText
                      primary="Assigned"
                      secondary={`Assigned to ${selectedVuln.assignedTo}`}
                    />
                    <Typography variant="caption" color="text.secondary">1 day ago</Typography>
                  </ListItem>
                )}
                {selectedVuln.status === 'in-progress' && (
                  <ListItem>
                    <ListItemIcon><TrendingUpIcon fontSize="small" /></ListItemIcon>
                    <ListItemText
                      primary="In Progress"
                      secondary="Remediation started"
                    />
                    <Typography variant="caption" color="text.secondary">12 hours ago</Typography>
                  </ListItem>
                )}
                {selectedVuln.status === 'resolved' && (
                  <ListItem>
                    <ListItemIcon><CheckIcon fontSize="small" color="success" /></ListItemIcon>
                    <ListItemText
                      primary="Resolved"
                      secondary="Issue successfully remediated"
                    />
                    <Typography variant="caption" color="text.secondary">Just now</Typography>
                  </ListItem>
                )}
              </List>
            </>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setProgressDialogOpen(false)}>Close</Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};

export default VulnerabilityManagement;
