---
# ArgoCD Application for EASM Frontend
# This manifest deploys the EASM Frontend using the Helm chart in the repository
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: easm-frontend
  namespace: argocd
  # Finalizer ensures proper cleanup
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  # Project the application belongs to
  project: default

  # Source configuration - GHCR OCI Helm chart
  source:
    # OCI Helm chart in GitHub Container Registry
    chart: easm-frontend
    repoURL: oci://ghcr.io/secpodvn/charts

    # Target revision (chart version)
    # This will be automatically updated by GitHub Actions
    targetRevision: 0.1.0-latest

    # Helm-specific configuration
    helm:
      # Release name (optional, defaults to application name)
      releaseName: easm-frontend

      # Additional Helm values (override chart defaults)
      values: |
        # Image configuration
        image:
          repository: ghcr.io/secpodvn/easm-rnd/easm-frontend
          tag: latest
          pullPolicy: Always

        # Image pull secrets for private registry
        imagePullSecrets:
          - name: ghcr-secret

        # Replica count
        replicaCount: 1

        # Service configuration
        service:
          type: ClusterIP
          port: 80

        # Ingress configuration
        ingress:
          enabled: true
          className: nginx
          annotations:
            nginx.ingress.kubernetes.io/rewrite-target: /
          hosts:
            - host: easm-frontend.local
              paths:
                - path: /
                  pathType: Prefix

        # Resource limits
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi

        # Frontend environment configuration
        frontend:
          # API backend URL (service name in Kubernetes)
          apiUrl: "http://easm-api:8000"
          environment: "development"

  # Destination cluster and namespace
  destination:
    # Cluster URL (in-cluster URL for MicroK8s)
    server: https://kubernetes.default.svc

    # Target namespace (same as API)
    namespace: easm-platform

  # Sync policy configuration
  syncPolicy:
    # Automatically sync when changes are detected in Git
    automated:
      # Prune resources that are no longer defined in Git
      prune: true

      # Allow automatic self-healing when resources drift from desired state
      selfHeal: true

      # Allow empty resources (useful during initial setup)
      allowEmpty: false

    # Sync options
    syncOptions:
      # Create namespace if it doesn't exist
      - CreateNamespace=true

      # Validate resources before applying
      - Validate=true

      # Use server-side apply
      - ServerSideApply=true

    # Retry configuration for failed syncs
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  # Health assessment configuration
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas
